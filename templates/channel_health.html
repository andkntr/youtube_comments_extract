{% extends "base.html" %}
{% block title %}チャンネル健診{% endblock %}

{% block content %}
<div class="container py-5">
  <h1 class="text-center mb-4">チャンネル健診</h1>

  <!-- 入力フォーム -->
  <form method="POST" class="mb-5">
    <div class="input-group">
      <input type="text" class="form-control" name="channel"
             placeholder="チャンネルURL / @ハンドル / UC ID" required>
      <button class="btn btn-primary" type="submit">分析する</button>
    </div>
  </form>

  {% if summary %}
  <!-- サマリカード -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h4 class="card-title">{{ summary["チャンネル名"] }}</h4>
      <p class="text-muted">{{ summary["説明"] }}</p>
      <div class="row">
        <div class="col-md-4">登録者数: {{ summary["登録者数"]|int|"{:,}".format }}</div>
        <div class="col-md-4">総再生回数: {{ summary["総再生回数"]|int|"{:,}".format }}</div>
        <div class="col-md-4">動画数: {{ summary["総動画数"] }}</div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4">国: {{ summary["国"] }}</div>
        <div class="col-md-4">開設日: {{ summary["開設日"][:10] }}</div>
      </div>
    </div>
  </div>

  <!-- 統計カード -->
  <div class="row mb-4 text-center">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>平均再生数</h5>
          <p class="fs-4">{{ stats["平均再生数"]|int|"{:,}".format }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>中央値再生数</h5>
          <p class="fs-4">{{ stats["中央値再生数"]|int|"{:,}".format }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>平均いいね率</h5>
          <p class="fs-4">{{ stats["平均いいね率"] }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- グラフ -->
  <h3 class="mb-3">直近動画の推移</h3>
  <div id="viewsChart"></div>

  <!-- 動画一覧 -->
  <h3 class="mt-5 mb-3">直近動画一覧</h3>
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>公開日</th>
        <th>サムネイル</th>
        <th>タイトル</th>
        <th>再生数</th>
        <th>高評価数</th>
        <th>コメント数</th>
      </tr>
    </thead>
    <tbody>
      {% for v in videos %}
      <tr>
        <td>{{ v["公開日"][:10] }}</td>
        <td><img src="{{ v['サムネイル'] }}" width="120"></td>
        <td><a href="{{ v['URL'] }}" target="_blank">{{ v["タイトル"] }}</a></td>
        <td>{{ v["再生数"]|int|"{:,}".format }}</td>
        <td>{{ v["高評価数"]|int|"{:,}".format }}</td>
        <td>{{ v["コメント数"]|int|"{:,}".format }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% if videos %}
<script>
const videos = {{ videos|tojson }};
const x = videos.map(v => v["公開日"].slice(0,10)).reverse();
const views = videos.map(v => v["再生数"]).reverse();
const likes = videos.map(v => v["高評価数"]).reverse();

const trace1 = {x:x, y:views, type:'bar', name:'再生数'};
const trace2 = {x:x, y:likes, type:'line', name:'高評価数', yaxis:'y2'};

const layout = {
  title: '直近動画の再生数と高評価数',
  xaxis: {title: '公開日'},
  yaxis: {title: '再生数'},
  yaxis2: {title: '高評価数', overlaying:'y', side:'right'}
};

Plotly.newPlot('viewsChart', [trace1, trace2], layout);
</script>
{% endif %}
{% endblock %}
